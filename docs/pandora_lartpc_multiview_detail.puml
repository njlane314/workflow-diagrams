@startuml Pandora_LArTPC_MultiViewDetail
' ============================================================
' Pandora reconstruction in LArTPCs — multi-view 2D→3D detail
' (per-slice conceptual view; engineering-style layout)
' ============================================================

 ' ---- Engineering palette (light + print-friendly) ----
!$BG        = "#FFFFFF"
!$FG        = "#111111"
!$LINE      = "#2B2B2B"

!$PKG_BG    = "#F6F6F6"
!$PKG_BR    = "#B8B8B8"

!$PAND_BG   = "#E9F2FF"  ' algorithms (Pandora)
!$PAND_BR   = "#2E5AAC"
!$DATA_BG   = "#FFF4D6"  ' data products
!$DATA_BR   = "#B07D00"
!$NOTE_BG   = "#F3F3F3"
!$NOTE_BR   = "#9C9C9C"

skinparam backgroundColor $BG
skinparam defaultFontName "Helvetica"
skinparam defaultFontSize 12
skinparam defaultFontColor $FG
skinparam shadowing false
skinparam roundcorner 4
skinparam linetype ortho
skinparam ArrowColor $LINE
skinparam ArrowThickness 1
skinparam componentStyle rectangle

skinparam packageStyle rectangle
skinparam PackageBackgroundColor $PKG_BG
skinparam PackageBorderColor $PKG_BR
skinparam PackageFontColor $FG

hide stereotype

skinparam component<<pandora>> {
  BackgroundColor $PAND_BG
  BorderColor $PAND_BR
  FontColor $FG
}
skinparam rectangle<<data>> {
  BackgroundColor $DATA_BG
  BorderColor $DATA_BR
  FontColor $FG
}
skinparam note {
  BackgroundColor $NOTE_BG
  BorderColor $NOTE_BR
  FontColor $FG
}

title Pandora (per slice): multi-view 2D → 3D pattern recognition

rectangle "Slice CaloHits\n(all planes: U, V, Y)" as SLICEH <<data>>

 ' keep the three plane blocks aligned horizontally
together {
  package "U view (induction)" as U {
    rectangle "U CaloHits" as UH <<data>>
    component "2D clustering (U)\n- seed/grow\n- split/merge" as UC <<pandora>>
    rectangle "2D clusters (U)" as U2 <<data>>
    UH -down-> UC
    UC -down-> U2
  }

  package "V view (induction)" as V {
    rectangle "V CaloHits" as VH <<data>>
    component "2D clustering (V)\n- seed/grow\n- split/merge" as VC <<pandora>>
    rectangle "2D clusters (V)" as V2 <<data>>
    VH -down-> VC
    VC -down-> V2
  }

  package "Y view (collection)" as Y {
    rectangle "Y CaloHits" as YH <<data>>
    component "2D clustering (Y)\n- seed/grow\n- split/merge" as YC <<pandora>>
    rectangle "2D clusters (Y)" as Y2 <<data>>
    YH -down-> YC
    YC -down-> Y2
  }
}

SLICEH -down-> UH
SLICEH -down-> VH
SLICEH -down-> YH

component "Cross-view association\n- match 2D clusters across planes\n- constraints: geometry + drift-time" as XVIEW <<pandora>>
rectangle "3D clusters / prongs\n(spacepoints, skeletons)" as C3D <<data>>

U2 -down-> XVIEW
V2 -down-> XVIEW
Y2 -down-> XVIEW
XVIEW -down-> C3D

component "Topology refinement (iterative)\n- resolve ambiguities\n- missing-view recovery\n- fragment removal\n- prong split/merge" as REF <<pandora>>
component "Track/shower building\n- track-like: linear, MIP-like\n- shower-like: branching, widening" as TS <<pandora>>
component "Vertex hypothesis\n- connect prongs to common origin" as VTX <<pandora>>
component "PFO hierarchy assembly\n- parent–daughter\n- interaction tree" as PFO <<pandora>>
rectangle "Slice-level PFOs\n+ associations & scores" as OUT <<data>>

C3D -down-> REF
REF -down-> TS
TS -down-> VTX
VTX -down-> PFO
PFO -down-> OUT

note right of XVIEW
Assumption:
Each wire-plane gives a 2D projection.
3D is obtained by combining:
- drift coordinate (x from time)
- wire geometry constraints
- topological consistency
end note

note right of TS
Typical discriminants:
- track: straightness, ~constant dQ/dx
- shower: start dE/dx, lateral spread, branching
end note

legend bottom
|= Fill |= Meaning |
|<#E9F2FF>| Pandora algorithm block |
|<#FFF4D6>| Data product passed between stages |
|<#F3F3F3>| Explanatory note |
endlegend

@enduml
