@startuml Pandora_LArTPC_MultiViewDetail
' =============================================================================
' Pandora reconstruction in LArTPCs — multi-view 2D→3D detail
' (per-slice conceptual view)
' =============================================================================
' If your renderer has layout issues, try commenting out the next line.
!pragma layout smetana

hide stereotype
skinparam backgroundColor #FFFFFF
skinparam linetype ortho
skinparam shadowing true
skinparam roundCorner 14
skinparam dpi 160
skinparam defaultTextAlignment center
skinparam nodesep 40
skinparam ranksep 35
skinparam ArrowThickness 1.3
skinparam ArrowColor #2C3E50
skinparam packageStyle rectangle
skinparam componentStyle rectangle

' --- Color palette via stereotypes -------------------------------------------
skinparam package<<view>> {
  BackgroundColor #ECEFF1
  BorderColor #455A64
  FontColor #263238
}

skinparam component<<larsoft>> {
  BackgroundColor #F1F8E9
  BorderColor #2E7D32
  FontColor #1B5E20
}

skinparam artifact<<data>> {
  BackgroundColor #FFFFFF
  BorderColor #37474F
  FontColor #263238
}

skinparam note {
  BackgroundColor #FFF3E0
  BorderColor #EF6C00
  FontColor #4E342E
}

title <size:18><b>Inside Pandora (per slice): multi-view 2D → 3D pattern recognition</b></size>

artifact "Slice CaloHits\n(all planes: U, V, Y)" as SLICEH <<data>>

package "U view (induction)" as U <<view>> {
  artifact "U CaloHits" as UH <<data>>
  component "2D clustering U\n(seed/grow/split/merge)" as UC <<larsoft>>
  artifact "2D clusters U" as U2 <<data>>
  UH --> UC
  UC --> U2
}

package "V view (induction)" as V <<view>> {
  artifact "V CaloHits" as VH <<data>>
  component "2D clustering V\n(seed/grow/split/merge)" as VC <<larsoft>>
  artifact "2D clusters V" as V2 <<data>>
  VH --> VC
  VC --> V2
}

package "Y view (collection)" as Y <<view>> {
  artifact "Y CaloHits" as YH <<data>>
  component "2D clustering Y\n(seed/grow/split/merge)" as YC <<larsoft>>
  artifact "2D clusters Y" as Y2 <<data>>
  YH --> YC
  YC --> Y2
}

SLICEH --> UH
SLICEH --> VH
SLICEH --> YH

component "Cross-view association\n(match 2D clusters across planes)\nusing geometry + drift-time consistency" as XVIEW <<larsoft>>
artifact "3D clusters / prongs\n(spacepoints, skeletons)" as C3D <<data>>

U2 --> XVIEW
V2 --> XVIEW
Y2 --> XVIEW
XVIEW --> C3D

component "Topology refinement (iterative)\n• resolve ambiguities\n• missing-view recovery\n• fragment removal\n• prong splitting/merging" as REF <<larsoft>>
component "Track vs shower building\n• track-like: linear, MIP-like\n• shower-like: branching, increasing width" as TS <<larsoft>>
component "Vertex hypothesis\n(connect prongs to common origin)" as VTX <<larsoft>>
component "PFO hierarchy assembly\n(parent–daughter, interaction tree)" as PFO <<larsoft>>
artifact "Slice-level PFOs\n+ associations & scores" as OUT <<data>>

C3D --> REF
REF --> TS
TS --> VTX
VTX --> PFO
PFO --> OUT

note right of XVIEW
  <b>Principle:</b> each view gives a 2D projection.
  3D comes from combining:
  • shared drift coordinate (x from time)
  • wire geometry constraints
  • topological consistency
end note

note right of TS
  <b>Discriminants (typical):</b>
  • track: straightness, constant dQ/dx
  • shower: start dE/dx, spread, branching
end note

@enduml
