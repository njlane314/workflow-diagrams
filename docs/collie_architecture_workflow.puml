@startuml
' =============================================================================
' Collie: architecture + typical workflow  (A4 portrait tuned)
' =============================================================================
!pragma layout smetana

' --- A4 portrait fit helpers -------------------------------------------------
top to bottom direction
' A4 @ ~160 dpi is ~1320x1870 px; keep a margin to avoid clipping.
scale max 1250*1800

skinparam defaultFontSize 10
skinparam nodesep 18
skinparam ranksep 22

'
' --- Technical engineering theme (minimal, clean) -----------------------------
'
!$INK     = "#111827"
!$MUTED   = "#6B7280"
!$COLLIE  = "#0F766E"
!$EXT     = "#4B5563"
!$CFG     = "#B45309"
!$DATA    = "#111827"
!$NOTE_BG = "#F9FAFB"
!$NOTE_BR = "#9CA3AF"

hide stereotype
skinparam backgroundColor #FFFFFF
skinparam defaultFontName Helvetica
skinparam defaultFontColor $INK
skinparam linetype ortho
skinparam shadowing false
skinparam roundCorner 0
skinparam dpi 160
skinparam defaultTextAlignment center
skinparam LineThickness 1
skinparam ArrowThickness 1.1
skinparam ArrowColor $INK
skinparam packageStyle rectangle
skinparam componentStyle rectangle

' --- Color palette via stereotypes -------------------------------------------
skinparam component<<cfg>> {
  BackgroundColor #FEF3C7
  BorderColor $CFG
  FontColor $INK
}
skinparam artifact<<cfg>> {
  BackgroundColor #FEF3C7
  BorderColor $CFG
  FontColor $INK
}

skinparam package<<collie>> {
  BackgroundColor #E6FFFB
  BorderColor $COLLIE
  FontColor $INK
}
skinparam component<<collie>> {
  BackgroundColor #E6FFFB
  BorderColor $COLLIE
  FontColor $INK
}
skinparam artifact<<collie>> {
  BackgroundColor #E6FFFB
  BorderColor $COLLIE
  FontColor $INK
}

skinparam package<<ext>> {
  BackgroundColor #E5E7EB
  BorderColor $EXT
  FontColor $INK
}
skinparam component<<ext>> {
  BackgroundColor #E5E7EB
  BorderColor $EXT
  FontColor $INK
}
skinparam artifact<<ext>> {
  BackgroundColor #E5E7EB
  BorderColor $EXT
  FontColor $INK
}

skinparam database<<data>> {
  BackgroundColor #F3F4F6
  BorderColor $DATA
  FontColor $INK
}
skinparam artifact<<data>> {
  BackgroundColor #F3F4F6
  BorderColor $DATA
  FontColor $INK
}

skinparam note {
  BackgroundColor $NOTE_BG
  BorderColor $NOTE_BR
  FontColor $INK
}

' =============================================================================
' Job submission + configuration (generic)
' =============================================================================
component "User / analysis workflow\n(batch/grid/interactive)\nexec: collieIOmaker.exe\nexec: collieLimitCalc.exe" as USER <<cfg>>
artifact "Steering inputs\n(command line + config)\n• channels / mass grid\n• systematics\n• toys / scans\n• output naming" as CFG <<cfg>>

' =============================================================================
' External inputs & runtime deps
' =============================================================================
package "External inputs\n& deps" <<ext>> {
  artifact "ROOT histograms\n(data, signal, backgrounds)\nTH1/TH2/TH3" as HISTS <<ext>>
  component "ROOT\n(histograms + I/O)" as ROOT <<ext>>

  ' force vertical stack inside package
  HISTS -[hidden]d-> ROOT
}

' =============================================================================
' Stage 1: Collie I/O creation
' =============================================================================
package "Stage 1:\nI/O creation" <<collie>> {
  artifact "libCollieIO.so" as LIBIO <<collie>>

  component "collieIOmaker.exe\n(or user code)\n• read ROOT hists\n• define channels\n• write IO" as IOMAKER <<collie>>

  component "CollieIOFile API\n(CollieIOFile.hh)\ncreateChannel()\ncreateMassPoint()\ncreate*Systematic()\nstoreFile()" as IOAPI <<collie>>

  component "Mass grid\n(1D / 2D / 3D)" as GRID <<collie>>
  component "Systematics\nflat + shape\n(1D/2D, optional lists)" as SYST <<collie>>

  component "collieIOcondenser.exe\n(merge IO files)" as IOCOND <<collie>>

  database "CollieIO file(s)\n(ROOT)\nchannels + mass points\n+ systematics" as IOFILES <<data>>
  database "Merged CollieIO\n(ROOT)\n(optional)" as IOMERGED <<data>>

  ' force vertical stack inside package
  LIBIO   -[hidden]d-> IOMAKER
  IOMAKER -[hidden]d-> IOAPI
  IOAPI   -[hidden]d-> GRID
  GRID    -[hidden]d-> SYST
  SYST    -[hidden]d-> IOFILES
  IOFILES -[hidden]d-> IOCOND
  IOCOND  -[hidden]d-> IOMERGED
}

' =============================================================================
' Stage 2: limits & cross-section calculations
' =============================================================================
package "Stage 2:\nLimits & xsec\ncalculation" <<collie>> {
  artifact "libCollieLimit.so" as LIBLIM <<collie>>

  component "Executables\ncollieLimitCalc.exe\ncollieXsecCalc.exe\ncollieFastApprox.exe" as EXES <<collie>>

  component "CLs engines\n• CLfast  (no syst)\n• CLsyst  (w/ syst)\n• CLfit   (profile, 1 fit)\n• CLfit2  (profile, 2 fits)" as ENGINES <<collie>>

  component "High-level modes\nCrossSectionLimit\nExclusionLimit\nThreeSigmaEvidence\nCrossSectionCalc" as MODES <<collie>>

  component "Tools\nresultsFileCombiner.exe\ncollieXsecFitLoader.exe" as TOOLS <<collie>>

  database "Result files\n(ROOT)\nlimits, CLs curves,\nLLR distributions, scans" as RES <<data>>

  ' force vertical stack inside package
  LIBLIM  -[hidden]d-> EXES
  EXES    -[hidden]d-> ENGINES
  ENGINES -[hidden]d-> MODES
  MODES   -[hidden]d-> TOOLS
  TOOLS   -[hidden]d-> RES
}

' =============================================================================
' Bundled numerical libraries (used by limit stage)
' =============================================================================
package "Bundled numerical\nlibraries" <<ext>> {
  artifact "libCollieCLHEP.so\n(CLHEP)" as LIBCLHEP <<ext>>
  artifact "libCollieMinuit.a\n(MINUIT)" as LIBMINUIT <<ext>>

  ' force vertical stack inside package
  LIBCLHEP -[hidden]d-> LIBMINUIT
}

' =============================================================================
' Source tree / build map (high-level)
' =============================================================================
package "Source tree\n(high-level)" <<ext>> {
  component "io/" as DIRIO <<ext>>
  component "limit/" as DIRLIM <<ext>>
  component "minuit/" as DIRMIN <<ext>>
  component "CLHEP/" as DIRCL <<ext>>
  component "examples/\nhsnToy/\nhsnTest/" as DIREX <<ext>>

  ' force vertical stack inside package
  DIRIO  -[hidden]d-> DIRLIM
  DIRLIM -[hidden]d-> DIRMIN
  DIRMIN -[hidden]d-> DIRCL
  DIRCL  -[hidden]d-> DIREX
}

' =============================================================================
' Cross-package layout nudges (portrait stacking)
' =============================================================================
CFG     -[hidden]d-> HISTS
HISTS   -[hidden]d-> IOMAKER
IOFILES -[hidden]d-> EXES
RES     -[hidden]d-> LIBCLHEP
LIBCLHEP -[hidden]d-> DIRIO

' =============================================================================
' Relationships: configuration, inputs, and I/O build
' =============================================================================
USER -down-> CFG : selects run\n+ options
CFG  ..> IOMAKER : steering
HISTS -down-> IOMAKER : data/sig/bkg\nhistograms
ROOT  ..> IOMAKER

IOMAKER --> IOAPI : uses API
IOAPI --> GRID
IOAPI --> SYST
IOAPI -down-> IOFILES : storeFile()

IOFILES -down-> IOCOND : optional merge
IOCOND  -down-> IOMERGED : write merged

LIBIO ..> IOAPI : compiled API

' =============================================================================
' Relationships: limit / xsec calculation data flow
' =============================================================================
IOFILES  -down-> EXES : input CollieIO
IOMERGED -down-> EXES : (alt input)\nmerged IO

EXES --> ENGINES
ENGINES --> MODES
MODES -down-> RES : write outputs

TOOLS --> RES : combine / post-process

' External / bundled deps
ROOT <.. IOFILES
ROOT <.. IOMERGED
ROOT <.. RES

LIBLIM ..> LIBMINUIT : minimization\n(profile fits)
LIBLIM ..> LIBCLHEP : stats utilities
EXES  ..> LIBLIM : link
TOOLS ..> LIBLIM : link

' =============================================================================
' Source tree → build artifacts mapping
' =============================================================================
DIRIO  --> LIBIO
DIRLIM --> LIBLIM
DIRMIN --> LIBMINUIT
DIRCL  --> LIBCLHEP
DIREX  ..> LIBIO
DIREX  ..> LIBLIM

note bottom of IOFILES
  <b>Two-stage workflow</b>
  1) Build CollieIO ROOT files from histograms
     (channels, mass points, systematics).
  2) Run CLs / profile-likelihood calculations
     to produce limits, evidence, or xsec results.
end note

note bottom of ENGINES
  <b>Model</b>
  lambda_i(mu,theta) = b_i(theta) + mu*s_i(theta)

  <b>Profile objective</b>
  q(mu,theta) = 2 * sum_i [
    lambda_i - n_i - n_i*ln(lambda_i/n_i)
  ] + DeltaChi2_syst(theta)

  <b>LLR & CLs</b>
  LLR(mu) = -2 ln(
    L(data|mu, theta_hat_mu) /
    L(data|0,  theta_hat_0)
  )
  CLs = CLs+b / CLb ; exclude at CLs = 0.05
end note

@enduml
