@startuml
' =============================================================================
' EventSelectionFilter analysis flow (portrait tuned)
' =============================================================================
!pragma layout smetana

top to bottom direction
scale max 1100*1650

skinparam defaultFontSize 10
skinparam nodesep 14
skinparam ranksep 18

!$INK     = "#111827"
!$MUTED   = "#6B7280"
!$ART     = "#1D4ED8"
!$TOOLS   = "#15803D"
!$CFG     = "#B45309"
!$DATA    = "#111827"
!$NOTE_BG = "#F9FAFB"
!$NOTE_BR = "#9CA3AF"

hide stereotype
skinparam backgroundColor #FFFFFF
skinparam defaultFontName Helvetica
skinparam defaultFontColor $INK
skinparam linetype ortho
skinparam shadowing false
skinparam roundCorner 0
skinparam dpi 160
skinparam defaultTextAlignment center
skinparam LineThickness 1
skinparam ArrowThickness 1.1
skinparam ArrowColor $INK
skinparam packageStyle rectangle
skinparam componentStyle rectangle

skinparam component<<cfg>> {
  BackgroundColor #FEF3C7
  BorderColor $CFG
  FontColor $INK
}
skinparam artifact<<cfg>> {
  BackgroundColor #FEF3C7
  BorderColor $CFG
  FontColor $INK
}

skinparam package<<art>> {
  BackgroundColor #E3EAFD
  BorderColor $ART
  FontColor $INK
}
skinparam component<<art>> {
  BackgroundColor #E3EAFD
  BorderColor $ART
  FontColor $INK
}

skinparam package<<tools>> {
  BackgroundColor #E0F2E9
  BorderColor $TOOLS
  FontColor $INK
}
skinparam component<<tools>> {
  BackgroundColor #E0F2E9
  BorderColor $TOOLS
  FontColor $INK
}

skinparam database<<data>> {
  BackgroundColor #F3F4F6
  BorderColor $DATA
  FontColor $INK
}
skinparam artifact<<data>> {
  BackgroundColor #F3F4F6
  BorderColor $DATA
  FontColor $INK
}

skinparam note {
  BackgroundColor $NOTE_BG
  BorderColor $NOTE_BR
  FontColor $INK
}

' =============================================================================
' Configuration
' =============================================================================
component "Job launcher\nlar -c <job>.fcl" as USER <<cfg>>
artifact "FHiCL job config\nSelectionTool + AnalysisTools" as FCL <<cfg>>

' =============================================================================
' art runtime + module
' =============================================================================
package "art event processing" <<art>> {
  component "EventSelectionFilter\n(EDFilter module)" as FILTER <<art>>
  component "TFileService\nROOT output" as TFS <<art>>
  database "art::Event\n(run/subrun/event)" as EVENT <<data>>
}

' =============================================================================
' Tools and plugins
' =============================================================================
package "Selection + analysis tools" <<tools>> {
  component "SelectionToolBase\n(NeutrinoSelection)" as SEL <<tools>>
  component "AnalysisToolBase\n(Default, Energy,\nTruth, ...)" as ANA <<tools>>
  ' Keep the tools stacked to reduce horizontal spread/whitespace
  SEL -[hidden]down-> ANA
}

' =============================================================================
' Inputs and intermediate data
' =============================================================================
package "Reco products" <<data>> {
  artifact "PFParticle proxy\n+ associated Track/Vertex/Cluster" as PFP <<data>>
}

' =============================================================================
' Output
' =============================================================================
artifact "TTree output\nEventSelectionFilter + SubRun" as TREE <<data>>

' =============================================================================
' Relationships: configuration & startup
' =============================================================================
USER -down-> FCL : selects\nworkflow
FCL ..> FILTER : module\nconfiguration
FCL ..> SEL : SelectionTool\npset
FCL ..> ANA : AnalysisTools\npsets

' =============================================================================
' Relationships: event loop
' =============================================================================
EVENT -down-> FILTER : filter(art::Event)
FILTER --> PFP : proxy::getCollection
FILTER --> SEL : selectEvent(slice)
FILTER --> ANA : analyseEvent\n+ analyseSlice
FILTER --> TFS : creates\nTTrees
TFS --> TREE : ROOT\noutput file

' =============================================================================
' Selection flow
' =============================================================================
PFP -down-> FILTER : BuildPFPMap\nAddDaughters
FILTER -down-> SEL : neutrino slice
SEL -down-> FILTER : selected flag
FILTER -down-> ANA : per-slice\nanalysis

note bottom of FILTER
  1) ResetTTree
  2) Build PFParticle proxy
  3) Analyse full event
  4) Build neutrino slices
  5) Select + analyse slices
  6) Fill TTrees
  7) Optionally filter event
end note

@enduml
