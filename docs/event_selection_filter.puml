@startuml
' =============================================================================
' EventSelectionFilter analysis flow (A4 portrait, wider/shorter)
' =============================================================================
!pragma layout smetana

top to bottom direction
scale max 1400*1200

skinparam defaultFontSize 10
skinparam nodesep 20
skinparam ranksep 14

!$INK     = "#111827"
!$MUTED   = "#6B7280"
!$ART     = "#1D4ED8"
!$TOOLS   = "#15803D"
!$CFG     = "#B45309"
!$DATA    = "#111827"
!$NOTE_BG = "#F9FAFB"
!$NOTE_BR = "#9CA3AF"

hide stereotype
skinparam backgroundColor #FFFFFF
skinparam defaultFontName Helvetica
skinparam defaultFontColor $INK
skinparam linetype ortho
skinparam shadowing false
skinparam roundCorner 0
skinparam dpi 160
skinparam defaultTextAlignment center
skinparam LineThickness 1
skinparam ArrowThickness 1.1
skinparam ArrowColor $INK
skinparam packageStyle rectangle
skinparam componentStyle rectangle
skinparam packagePadding 6

skinparam component<<cfg>> {
  BackgroundColor #FEF3C7
  BorderColor $CFG
  FontColor $INK
}
skinparam artifact<<cfg>> {
  BackgroundColor #FEF3C7
  BorderColor $CFG
  FontColor $INK
}
skinparam package<<cfg>> {
  BackgroundColor #FEF3C7
  BorderColor $CFG
  FontColor $INK
}

skinparam package<<art>> {
  BackgroundColor #E3EAFD
  BorderColor $ART
  FontColor $INK
}
skinparam component<<art>> {
  BackgroundColor #E3EAFD
  BorderColor $ART
  FontColor $INK
}

skinparam package<<tools>> {
  BackgroundColor #E0F2E9
  BorderColor $TOOLS
  FontColor $INK
}
skinparam component<<tools>> {
  BackgroundColor #E0F2E9
  BorderColor $TOOLS
  FontColor $INK
}

skinparam package<<data>> {
  BackgroundColor #F3F4F6
  BorderColor $DATA
  FontColor $INK
}
skinparam database<<data>> {
  BackgroundColor #F3F4F6
  BorderColor $DATA
  FontColor $INK
}
skinparam artifact<<data>> {
  BackgroundColor #F3F4F6
  BorderColor $DATA
  FontColor $INK
}

skinparam note {
  BackgroundColor $NOTE_BG
  BorderColor $NOTE_BR
  FontColor $INK
}

' =============================================================================
' Configuration
' =============================================================================
package "Run configuration" <<cfg>> {
  component "Job launcher\nlar -c <job>.fcl" as USER <<cfg>>
  artifact "FHiCL job config\nSelectionTool + AnalysisTools" as FCL <<cfg>>
  USER -[hidden]down-> FCL
}

' =============================================================================
' Inputs (event + reco products)
' =============================================================================
package "Inputs (event + reco)" <<data>> {
  database "art::Event\n(run/subrun/event)" as EVENT <<data>>
  artifact "PFParticle proxy\n+ associated Track/Vertex/Cluster" as PFP <<data>>
  EVENT -[hidden]down-> PFP
}

' =============================================================================
' art runtime + module
' =============================================================================
package "EventSelectionFilter (art module)" <<art>> {
  component "EventSelectionFilter\n(EDFilter module)" as FILTER <<art>>
}

' =============================================================================
' Tools and plugins
' =============================================================================
package "Selection + analysis tools" <<tools>> {
  component "SelectionToolBase\n(NeutrinoSelection)" as SEL <<tools>>
  component "AnalysisToolBase\n(Default, Energy,\nTruth, ...)" as ANA <<tools>>
  SEL -[hidden]down-> ANA
}

' =============================================================================
' Output
' =============================================================================
package "ROOT output" <<art>> {
  component "TFileService\n(ROOT output)" as TFS <<art>>
  artifact "TTree output\nEventSelectionFilter + SubRun" as TREE <<data>>
  TFS -[hidden]down-> TREE
}

' =============================================================================
' Layout: make the core flow shorter and use page width (fits top 1/2â€“2/3 of A4)
' =============================================================================
FCL    -[hidden]down-> FILTER
EVENT  -[hidden]right-> FILTER
FILTER -[hidden]right-> SEL
FILTER -[hidden]down-> TFS

' =============================================================================
' Relationships: configuration & startup
' =============================================================================
USER -down-> FCL : selects\nworkflow
FCL ..> FILTER : module\nconfiguration
FCL ..> SEL : SelectionTool\npset
FCL ..> ANA : AnalysisTools\npsets

' =============================================================================
' Relationships: event loop
' =============================================================================
EVENT -right-> FILTER : filter(art::Event)
PFP -right-> FILTER : proxy::getCollection\nBuildPFPMap + AddDaughters
FILTER -right-> SEL : build slices\nselectEvent(slice)
SEL -left-> FILTER : selected flag
FILTER -right-> ANA : analyseEvent\n+ analyseSlice
FILTER -down-> TFS : creates\nTTrees
TFS -down-> TREE : ROOT\noutput file
ANA ..> TREE : fills\nbranches

legend right
  1) ResetTTree
  2) Build PFParticle proxy
  3) Analyse full event
  4) Build neutrino slices
  5) Select + analyse slices
  6) Fill TTrees
  7) Optionally filter event
end legend

@enduml
